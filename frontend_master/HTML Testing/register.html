<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Nest - Create Account</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="ring" style="--clr:#64b5f6">
    <i></i>
    <i></i>
    <i></i>

    <div class="login">
      <div class="login-box" id="root"></div>
    </div>
  </div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState } = React;

    function RegisterForm() {
      const [studentId, setStudentId] = useState("");
      const [name, setName] = useState("");
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [confirm, setConfirm] = useState("");
      const [role, setRole] = useState("student");
      const [status, setStatus] = useState("");
      const [isBusy, setIsBusy] = useState(false);

      const validate = () => {
        if (!studentId.trim()) return "Student ID is required.";
        if (!name.trim()) return "Name is required.";
        if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) return "Please enter a valid email.";
        if (password.length < 8) return "Password must be at least 8 characters.";
        if (password !== confirm) return "Passwords do not match.";
        return null;
      };

      const onSubmit = async (e) => {
        e.preventDefault();
        const err = validate();
        if (err) { setStatus(err); return; }

        setIsBusy(true);
        setStatus("Creating your account...");

        try {
          const res = await fetch(`http://localhost:8080/auth/register/${role}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              student_id: studentId.trim(),
              name: name.trim(),
              email: email.trim(),
              password
            })
          });

          let data = {};
          try { data = await res.json(); } catch {}

          if (!res.ok || data.ok === false) {
            const s = res.status || "";
            const m = (data && (data.message || data.error)) || "Registration failed";
            window.location.href = "/account_unsuccessful.html?status=" + encodeURIComponent(String(s)) + "&msg=" + encodeURIComponent(m);
            return;
          }

          if (data.token) localStorage.setItem("authToken", data.token);
          const next = "/login.html";
          window.location.href = "/account_successful.html?next=" + encodeURIComponent(next);
        } catch (err) {
          window.location.href = "/account_unsuccessful.html?status=network&msg=" + encodeURIComponent(err.message || "Network error");
        }
      };

      return (
        <>
          <h2>Create Your StudentNest Account</h2>
          <form onSubmit={onSubmit} noValidate>
            <input
              type="text"
              placeholder="Student ID"
              required
              value={studentId}
              onChange={(e) => setStudentId(e.target.value)}
            />
            <input
              type="text"
              placeholder="Full Name"
              required
              value={name}
              onChange={(e) => setName(e.target.value)}
            />
            <input
              type="text"
              placeholder="Email"
              required
              value={email}
              onChange={(e) => setEmail(e.target.value)}
            />
            <input
              type="password"
              placeholder="Password (min 8 chars)"
              required
              value={password}
              onChange={(e) => setPassword(e.target.value)}
            />
            <input
              type="password"
              placeholder="Confirm Password"
              required
              value={confirm}
              onChange={(e) => setConfirm(e.target.value)}
            />

            <div style={{ display: 'flex', gap: 8, justifyContent: 'center' }}>
              <label style={{ color: '#eee', fontSize: 14 }}>
                <input
                  type="radio"
                  name="role"
                  value="student"
                  checked={role === 'student'}
                  onChange={() => setRole('student')}
                  style={{ marginRight: 6 }}
                />
                Student
              </label>
              <label style={{ color: '#eee', fontSize: 14 }}>
                <input
                  type="radio"
                  name="role"
                  value="teacher"
                  checked={role === 'teacher'}
                  onChange={() => setRole('teacher')}
                  style={{ marginRight: 6 }}
                />
                Teacher
              </label>
              <label style={{ color: '#eee', fontSize: 14 }}>
                <input
                  type="radio"
                  name="role"
                  value="admin"
                  checked={role === 'admin'}
                  onChange={() => setRole('admin')}
                  style={{ marginRight: 6 }}
                />
                Admin
              </label>
            </div>

            <button type="submit" className="login-btn" disabled={isBusy}>
              {isBusy ? 'Creatingâ€¦' : 'Create Account'}
            </button>

            <div className="signup-row">
              Already have an account?
              <a href="/login.html" className="signup-link"> Log In</a>
            </div>
          </form>

          {status && <div className="note" style={{ marginTop: 8 }}>{status}</div>}
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<RegisterForm />);
  </script>
</body>
</html>
